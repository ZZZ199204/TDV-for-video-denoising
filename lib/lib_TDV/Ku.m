function w = Ku(Kcal,u,params)

[M,N,T] = size(u);

Q = params.order;

switch Q
    case 1
        K = Kcal{1};
        w = cat(2,...
            K{1}*u(:),...
            K{2}*u(:),...
            K{3}*u(:),...
            K{4}*u(:),...
            K{5}*u(:),...
            K{6}*u(:));
        
    case 2
        K = Kcal{2};
        w = cat(2,...
            K{1}*u(:),...
            K{2}*u(:),...
            K{3}*u(:),...
            K{4}*u(:),...
            K{5}*u(:),...
            K{6}*u(:),...
            K{7}*u(:),...
            K{8}*u(:),...
            K{9}*u(:),...
            K{10}*u(:),...
            K{11}*u(:),...
            K{12}*u(:));
        
    case 3
        K = Kcal{3};
        w = cat(2,...
            K{1}*u(:),...
            K{2}*u(:),...
            K{3}*u(:),...
            K{4}*u(:),...
            K{5}*u(:),...
            K{6}*u(:),...
            K{7}*u(:),...
            K{8}*u(:),...
            K{9}*u(:),...
            K{10}*u(:),...
            K{11}*u(:),...
            K{12}*u(:),...
            K{13}*u(:),...
            K{14}*u(:),...
            K{15}*u(:),...
            K{16}*u(:),...
            K{17}*u(:),...
            K{18}*u(:),...
            K{19}*u(:),...
            K{20}*u(:),...
            K{21}*u(:),...
            K{22}*u(:),...
            K{23}*u(:),...
            K{24}*u(:));
end

w = reshape(w,M-3,N-3,T-3,3*2^Q);
