function [LR,I] = build_M(v,aniso,time_gain,varying)

[M,N,T,~] = size(v); 
ID = ones(M,N,T);

% CONTRACTION MATRIX on cell centres
if varying
%     B      = {           aniso(:,:,:,1),ID,...
%                time_gain*aniso(:,:,:,2),time_gain*ID,...
%                time_gain*aniso(:,:,:,3),time_gain*ID}; % ellipse shape
    B      = { aniso(:,:,:,1), aniso(:,:,:,2),...
               aniso(:,:,:,3), aniso(:,:,:,4),...
               aniso(:,:,:,5), aniso(:,:,:,6)}; % ellipse shape
else
    b = 0.1;
    B      = {0.1*ID,ID,...
              0.1*ID,ID,...
              0.1*ID,ID}; % ellipse shape
end

% L is MxNx2x2x3 where 2x2 is for the tensor and 3 is the number of fields
L = zeros(M,N,T,2,2,3);
% for {i,j}
L(:,:,:,1,1,1) = B{1}.*ID;
L(:,:,:,2,2,1) = B{2}.*ID;
% for {i,k}
L(:,:,:,1,1,2) = B{3}.*ID;
L(:,:,:,2,2,2) = B{4}.*ID;
% for {j,k}
L(:,:,:,1,1,3) = B{5}.*ID;
L(:,:,:,2,2,3) = B{6}.*ID;

% CLOCKWISE ROTATION on cell centres
% rows x cols x time x 2x2 x field number
R = zeros(M,N,T,2,2,3);

% for {i,j} 
R(:,:,:,1,1,1) =   v(:,:,:,1);  R(:,:,:,1,2,1) = v(:,:,:,2);
R(:,:,:,2,1,1) =  -v(:,:,:,2);  R(:,:,:,2,2,1) = v(:,:,:,1);
% for {i,k}
R(:,:,:,1,1,2) =   v(:,:,:,3);  R(:,:,:,1,2,2) = v(:,:,:,4);
R(:,:,:,2,1,2) =  -v(:,:,:,4);  R(:,:,:,2,2,2) = v(:,:,:,3);
% for {j,k}
R(:,:,:,1,1,3) =   v(:,:,:,5);  R(:,:,:,1,2,3) = v(:,:,:,6);
R(:,:,:,2,1,3) =  -v(:,:,:,6);  R(:,:,:,2,2,3) = v(:,:,:,5);

% CONTRACTION-ROTATION
LR = zeros(M,N,T,2,2,3);
% for {i,j}
LR(:,:,:,1,1,1) = L(:,:,:,1,1,1).*R(:,:,:,1,1,1) + L(:,:,:,1,2,1).*R(:,:,:,2,1,1);
LR(:,:,:,1,2,1) = L(:,:,:,1,1,1).*R(:,:,:,1,2,1) + L(:,:,:,1,2,1).*R(:,:,:,2,2,1);
LR(:,:,:,2,1,1) = L(:,:,:,2,1,1).*R(:,:,:,1,1,1) + L(:,:,:,2,2,1).*R(:,:,:,2,1,1);
LR(:,:,:,2,2,1) = L(:,:,:,2,1,1).*R(:,:,:,1,2,1) + L(:,:,:,2,2,1).*R(:,:,:,2,2,1);
% for {i,k}
LR(:,:,:,1,1,2) = L(:,:,:,1,1,2).*R(:,:,:,1,1,2) + L(:,:,:,1,2,2).*R(:,:,:,2,1,2);
LR(:,:,:,1,2,2) = L(:,:,:,1,1,2).*R(:,:,:,1,2,2) + L(:,:,:,1,2,2).*R(:,:,:,2,2,2);
LR(:,:,:,2,1,2) = L(:,:,:,2,1,2).*R(:,:,:,1,1,2) + L(:,:,:,2,2,2).*R(:,:,:,2,1,2);
LR(:,:,:,2,2,2) = L(:,:,:,2,1,2).*R(:,:,:,1,2,2) + L(:,:,:,2,2,2).*R(:,:,:,2,2,2);
% for {j,k}
LR(:,:,:,1,1,3) = L(:,:,:,1,1,3).*R(:,:,:,1,1,3) + L(:,:,:,1,2,3).*R(:,:,:,2,1,3);
LR(:,:,:,1,2,3) = L(:,:,:,1,1,3).*R(:,:,:,1,2,3) + L(:,:,:,1,2,3).*R(:,:,:,2,2,3);
LR(:,:,:,2,1,3) = L(:,:,:,2,1,3).*R(:,:,:,1,1,3) + L(:,:,:,2,2,3).*R(:,:,:,2,1,3);
LR(:,:,:,2,2,3) = L(:,:,:,2,1,3).*R(:,:,:,1,2,3) + L(:,:,:,2,2,3).*R(:,:,:,2,2,3);

I = ones(M+3,N+3,T+3,2,2,3);